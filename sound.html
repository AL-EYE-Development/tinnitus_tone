<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone Generator Survey</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        .column { display: inline-block; vertical-align: top; width: 30%; padding: 10px; }
        
        button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:focus {
            outline: 2px solid #0056b3;
            outline-offset: 2px;
        }

        select, input { padding: 5px; margin: 5px; }
        #frequencyValue1, #frequencyValue2, #frequencyValue3 { font-weight: bold; }
        
        /* Slider Styles */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 80%;
            height: 8px;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #007BFF;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #007BFF;
            cursor: pointer;
            border-radius: 50%;
        }
        #volume1 {
            width: 50%; /* Adjust the width as needed */
        }

        .modal {
            display: block; /* Show the modal by default */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .box {
            display: inline-block;
            width: 100px;
            height: 25px;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Information Notice</h2>
            <p>Please read the following information before proceeding.</p>
            <button onclick="startCalibration()">Start Calibration</button>
        </div>
    </div>


    <h1>Tone Generator & Tinnitus Matching</h1>
    <br> OBS: turn down your volume before hitting play <br>

    <!-- Pause All Tones button -->
    <button onclick="pauseAllTones()" style="background-color: #2f2f2f;">Pause All Tones</button>
    <br>

    <div class="column" id="sound1">
        <h2>Sound 1</h2>

        <label for="waveform1">Waveform: </label>
        <select id="waveform1" onchange="updateWaveform(1)">
            <option value="sine">Sine</option>
            <option value="square">Square</option>
            <option value="triangle">Triangle</option>
            <option value="sawtooth">Sawtooth</option>
        </select>

        <label for="frequency1">Frequency (Hz): </label>
        <span id="frequencyValue1"> 440 Hz -  </span><br>
        <input type="range" id="frequency1" value="440" min="10" max="14000" step="10" oninput="updateFrequencyValue(1)">
        
        <br>
        <label for="volume1">Volume: </label>
        <input type="range" id="volume1" value="33" min="0" max="100" step="1" oninput="updateVolumeValue(1)" width="50vw">
        <span id="volumeValue1">33</span>
        <br>

        <button onclick="toggleTone(1)" id="toggleButton1">Play Tone</button>

    </div>

    <div class="column" id="addSound2">
        <button onclick="addSound(2)">Add Sound 2</button>
    </div>

    <div class="column" id="addSound3">
        <button onclick="addSound(3)">Add Sound 3</button>
    </div>


    <hr>

    <!-- make this a button -->
    <br> <div class="box"></div><br>
    <button onclick="handleMatchClick()" style="background-color: green;">
        Step 1: Click Here if sound now matches what you hear
    </button>
    <br> <div class="box"></div><br>
    <!-- add a text box -->
    <input type="text" id="tinnitusMatch" placeholder="Enter your tinnitus frequency here" style="width: 50%; margin-top: 10px; padding: 5px;">

    <br> <div class="box"></div><br>

    <hr>
    <button style="background-color: white; color: black; border: 3px solid black; border-radius: 8px; cursor: not-allowed; ">
        Step 2: Follow the questionaire below to complete the survey.
    </button>

    <br> <div class="box"></div><br>

    <iframe width="640px" height="20000vh" src="https://forms.office.com/Pages/ResponsePage.aspx?id=I_FR8s7JjkSSdzS7KFkR2QlLtcyM--1KpijKKDu9H1xUMjFYMkNKRzBRVTBBQzlVWEtFUE4xNTZKNC4u&embed=true" frameborder="0" marginwidth="0" marginheight="0" style="border: none; max-width:100%; max-height:100vh" allowfullscreen webkitallowfullscreen mozallowfullscreen msallowfullscreen> </iframe>


    
    <script type="text/javascript" src="./helper.js"></script>
    <script> 
        let audioCtx1, oscillator1, gainNode1;
        let audioCtx2, oscillator2, gainNode2;
        let audioCtx3, oscillator3, gainNode3;
        let isPlaying1 = false;
        let isPlaying2 = false;
        let isPlaying3 = false;

        function updateFrequencyValue(sound) {
            const freq = document.getElementById(`frequency${sound}`).value;
            document.getElementById(`frequencyValue${sound}`).textContent = freq;
            if (sound === 1 && oscillator1) {
                oscillator1.frequency.setValueAtTime(freq, audioCtx1.currentTime);
            } else if (sound === 2 && oscillator2) {
                oscillator2.frequency.setValueAtTime(freq, audioCtx2.currentTime);
            } else if (sound === 3 && oscillator3) {
                oscillator3.frequency.setValueAtTime(freq, audioCtx3.currentTime);
            }
            
            //print type of freq
            const note = getNoteFromFrequency(parseFloat(freq));
            document.getElementById(`frequencyValue${sound}`).textContent = `${freq} Hz ~${note}`;
        }

        function updateWaveform(sound) {
            const wave = document.getElementById(`waveform${sound}`).value;
            if (sound === 1 && oscillator1) {
                oscillator1.type = wave;
            } else if (sound === 2 && oscillator2) {
                oscillator2.type = wave;
            } else if (sound === 3 && oscillator3) {
                oscillator3.type = wave;
            }
        }

        function updateVolumeValue(sound) {
            const volume = document.getElementById(`volume${sound}`).value;
            document.getElementById(`volumeValue${sound}`).textContent = volume;
            if (sound === 1 && gainNode1) {
                gainNode1.gain.setValueAtTime(volume / 100, audioCtx1.currentTime);
            } else if (sound === 2 && gainNode2) {
                gainNode2.gain.setValueAtTime(volume / 100, audioCtx2.currentTime);
            } else if (sound === 3 && gainNode3) {
                gainNode3.gain.setValueAtTime(volume / 100, audioCtx3.currentTime);
            }
        }

        function toggleTone(sound) {
            if (sound === 1) {
                if (isPlaying1)     stopTone(1);
                else                playTone(1);
                isPlaying1 = !isPlaying1;
                document.getElementById("toggleButton1").textContent = isPlaying1 ? "Stop Tone ⏹️" : "Play Tone";
            } else if (sound === 2) {
                if (isPlaying2) {
                    stopTone(2);
                } else {
                    playTone(2);
                }
                isPlaying2 = !isPlaying2;
                document.getElementById("toggleButton2").textContent = isPlaying2 ? "Stop Tone ⏹️" : "Play Tone";
            } else if (sound === 3) {
                if (isPlaying3) {
                    stopTone(3);
                } else {
                    playTone(3);
                }
                isPlaying3 = !isPlaying3;
                document.getElementById("toggleButton3").textContent = isPlaying3 ? "Stop Tone ⏹️" : "Play Tone";
            }
        }

        function playTone(sound) {
            if (sound === 1) {
                if (audioCtx1) {
                    audioCtx1.close();
                }
                const freq = document.getElementById("frequency1").value;
                const wave = document.getElementById("waveform1").value;
                const volume = document.getElementById("volume1").value;
                
                audioCtx1 = new (window.AudioContext || window.webkitAudioContext)();
                oscillator1 = audioCtx1.createOscillator();
                gainNode1 = audioCtx1.createGain();
                
                oscillator1.type = wave;
                oscillator1.frequency.setValueAtTime(freq, audioCtx1.currentTime);
                gainNode1.gain.setValueAtTime(volume / 100, audioCtx1.currentTime);
                
                oscillator1.connect(gainNode1);
                gainNode1.connect(audioCtx1.destination);
                oscillator1.start();
            } else if (sound === 2) {
                if (audioCtx2) {
                    audioCtx2.close();
                }
                const freq = document.getElementById("frequency2").value;
                const wave = document.getElementById("waveform2").value;
                const volume = document.getElementById("volume2").value;
                
                audioCtx2 = new (window.AudioContext || window.webkitAudioContext)();
                oscillator2 = audioCtx2.createOscillator();
                gainNode2 = audioCtx2.createGain();
                
                oscillator2.type = wave;
                oscillator2.frequency.setValueAtTime(freq, audioCtx2.currentTime);
                gainNode2.gain.setValueAtTime(volume / 100, audioCtx2.currentTime);
                
                oscillator2.connect(gainNode2);
                gainNode2.connect(audioCtx2.destination);
                oscillator2.start();
            } else if (sound === 3) {
                if (audioCtx3) {
                    audioCtx3.close();
                }
                const freq = document.getElementById("frequency3").value;
                const wave = document.getElementById("waveform3").value;
                const volume = document.getElementById("volume3").value;
                
                audioCtx3 = new (window.AudioContext || window.webkitAudioContext)();
                oscillator3 = audioCtx3.createOscillator();
                gainNode3 = audioCtx3.createGain();
                
                oscillator3.type = wave;
                oscillator3.frequency.setValueAtTime(freq, audioCtx3.currentTime);
                gainNode3.gain.setValueAtTime(volume / 100, audioCtx3.currentTime);
                
                oscillator3.connect(gainNode3);
                gainNode3.connect(audioCtx3.destination);
                oscillator3.start();
            }
        }

        function stopTone(sound) {
            if (sound === 1 && oscillator1) {
                oscillator1.stop();
                audioCtx1.close();
                oscillator1 = null;
                audioCtx1 = null;
            } else if (sound === 2 && oscillator2) {
                oscillator2.stop();
                audioCtx2.close();
                oscillator2 = null;
                audioCtx2 = null;
            } else if (sound === 3 && oscillator3) {
                oscillator3.stop();
                audioCtx3.close();
                oscillator3 = null;
                audioCtx3 = null;
            }
        }

        function addSound(sound) {
            const soundHTML = `
                <h2>Sound ${sound}</h2>
                <label for="waveform${sound}">Waveform: </label>
                <select id="waveform${sound}" onchange="updateWaveform(${sound})">
                    <option value="sine">Sine</option>
                    <option value="square">Square</option>
                    <option value="triangle">Triangle</option>
                    <option value="sawtooth">Sawtooth</option>
                </select>

                <label for="frequency${sound}">Frequency (Hz): </label>
                <span id="frequencyValue${sound}">440</span><br>
                <input type="range" id="frequency${sound}" value="440" min="10" max="14000" step="10" oninput="updateFrequencyValue(${sound})">
                
                <label for="volume${sound}">Volume: </label>
                <input type="range" id="volume${sound}" value="33" min="0" max="100" step="1" oninput="updateVolumeValue(${sound})">
                <span id="volumeValue${sound}">33</span>

                <br>
                <button onclick="toggleTone(${sound})" id="toggleButton${sound}">Play Tone</button>
            `;

            if (sound === 2) {
                document.getElementById('addSound2').innerHTML = soundHTML;
            } else if (sound === 3) {
                document.getElementById('addSound3').innerHTML = soundHTML;
            }
        }

        function closeModal() {
            document.getElementById('infoModal').style.display = 'none';
        }

        function startCalibration() {
            // Add your calibration process here
            closeModal();
        }

        function handleMatchClick() {
            alert("Thank you for your feedback!");
            // Add any additional logic you need here
        }

    </script>

</body>
</html>